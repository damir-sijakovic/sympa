<link rel="stylesheet" href="{{rootUrl}}/assets/vendor/lightbox2-master/dist/css/lightbox.min.css">
<link rel="stylesheet" href="{{rootUrl}}/assets/vendor/dropzone-v6.0.0-beta.2/dropzone.css">

<style>
.sympa-bulk-actions, .sympa-list-options{
    display:flex;
    align-items: center;
    justify-content: center;
    flex-direction: column; 
    flex-direction: row;
    white-space: nowrap;
}

#sympa-list-titlebar, #sympa-list-bottom-bar{
    font-size: 12px !important;
     font-weight: 500;
     background: #eeeeee;
}


.sympa-toolbar-font{
    font-size: 12px !important;
}

.sympa-list-font{
    font-size: 12px !important;
    font-weight: 500;
}

.sympa-modal{
    background: #3e3e3ed1;
}

.sympa-file-container{
    height:64px; 
    width:64px; 
    background:#666; 
    border-radius: 6px; 
    overflow: clip;    
    background-image: linear-gradient(45deg, #a1a1a1 25%, #737373 25%, #737373 50%, #a1a1a1 50%, #a1a1a1 75%, #737373 75%, #737373 100%);
    background-size: 14.14px 14.14px;    
    box-shadow: rgba(0, 0, 0, 0.12) 0px 1px 3px, rgba(0, 0, 0, 0.24) 0px 1px 2px;
}

.sympa-file-container-text{
    
}


.modal-dialog{
    max-width: 80% !important;
}

#my-dropzone{
    border: 4px dashed lightgray;
}

</style>



<h2 id="sympa-title">Loading...</h2>

<p class="lead">{{slug}}</p>
<hr>

<div class="btn-group" role="group" aria-label="Basic example">
  <div onclick="sympa_openUploadModalAction()" class="btn btn-primary btn-sm"><i class="bi bi-plus-circle mx-1"></i>Upload files</div>
  <!--button type="button" class="btn btn-outline-primary btn-sm" onclick="sympa_reset()"> <i class="bi bi-search"></i> Search</button-->
</div>

<br><br>


<div id="sympa-no-file-list" class="alert alert-primary" role="alert" style="display:none">
  No files found!
</div>


<div id="sympa-main-content">

<ul id="sympa-file-list" class="list-group mb-3">
    
    <!--
        <li id="sympa-list-titlebar" class="list-group-item d-flex justify-content-between">             
			<div>
                <div class="sympa-bulk-actions">
                    <div>
                    <input style="margin-right: 1rem;" class="form-check-input" type="checkbox" onclick="sympa_tableCheck(this.checked)">
                    </div>     
                    <select class="form-select sympa-toolbar-font" aria-label="Default select example">
                      <option value="-1" selected>Bulk actions...</option>
                      <option value="1">Delete items</option>
                    </select>
                    <div onclick="sympa_applyBulk()" class="btn btn-light btn-sm sympa-toolbar-font">Apply</div>
                </div>                
                
            </div>
			<div class="d-flex">
            
                <button data="" style="display:none" onclick="sympa_openSetListValueModal()" id="sympa-list-value-button" type="button" class="btn btn-light btn-sm sympa-toolbar-font">Enter value...</button>
                            
                <div class="sympa-list-options mx-1">                    
                    <select id="sympa-select-right-sort" class="form-select sympa-toolbar-font" aria-label="Default select example">
                      <option selected onclick="sympa_changeListSort(this)" value="newest">Newest</option>
                      <option onclick="sympa_changeListMode(this)" value="oldest">Oldest</option>                
                    </select>
                    <button onclick="sympa_goAction()" type="button" class="btn btn-light btn-sm sympa-toolbar-font">Go</button>
                </div>
             
            </div>
        </li> 
        
         
         
        
         <li class="list-group-item d-flex justify-content-between bg-body-tertiary" title="ID: ${id} \nCreated: ${createdAt}\nModified: ${modifiedAt}" data-id="${id}">
            <div class="d-flex gap-3">                
                <input class="form-check-input sympa-bulk-checkbox" type="checkbox">
                <div class="d-flex justify-content-center align-items-center gap-1">  
                
                    <div class="d-flex justify-content-center align-items-center sympa-file-container">  
                        <img loading="lazy" src="{{rootUrl}}/uploads/images/group-one/image-one/image-0.png" style="height:64px"/>
                    </div>
                    
                    <div class="sympa-file-container-text">
                        <div style="display: flex;"> <h6 class="my-0">${name}</h6></div>  
                        <small>${description}</small>
                    </div>
                </div>
            </div>            
            <span class="text-success">
                <div class="btn-group" role="group" aria-label="Basic outlined example">                  
                  <a href="/dashboard/category-edit/${id}" class="btn btn-primary btn-sm sympa-list-font" target="_blank">View</a>
                  <div onclick="sympa_deleteImageModal(${id})" class="btn btn-outline-primary btn-sm sympa-list-font">Delete</div>
                </div>            
            </span>
          </li>
        
        
                
        
         <li class="list-group-item d-flex justify-content-between bg-body-tertiary" title="ID: ${id} \nCreated: ${createdAt}\nModified: ${modifiedAt}" data-id="${id}">
            <div class="d-flex gap-3">                
                <input class="form-check-input sympa-bulk-checkbox" type="checkbox">
                <div class="d-flex justify-content-center align-items-center gap-1">  
                
                    <div class="d-flex justify-content-center align-items-center sympa-file-container">  
                        <img loading="lazy" src="{{rootUrl}}/uploads/images/group-one/image-two/image-0.jpg" style="height:64px"/>
                    </div>
                    
                    <div class="sympa-file-container-text">
                        <div style="display: flex;"> <h6 class="my-0">${name}</h6></div>  
                        <small>${description}</small>
                    </div>
                </div>
            </div>            
            <span class="text-success">
                <div class="btn-group" role="group" aria-label="Basic outlined example">                  
                  <a href="/dashboard/category-edit/${id}" class="btn btn-primary btn-sm sympa-list-font" target="_blank">View</a>
                  <div onclick="sympa_deleteArticleModal(${id})" class="btn btn-outline-primary btn-sm sympa-list-font">Delete</div>
                </div>            
            </span>
          </li>
              
              
        <li class="list-group-item d-flex justify-content-between" id="sympa-list-bottom-bar">
            <div>Total: <span id="sympa-total-articles"></span> </div>
            <div id="sympa-bottom-right-message">::</div>
        </li> 
    
    
    -->
    
</ul>


</div>








<div class="modal sympa-modal" id="sympa-upload-modal" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header justify-content-between">
      <div>
        <button type="button" class="btn btn-outline-primary btn-lg m-1" onclick="sympa_uploadModalAction()">Upload</button>
        <button type="button" class="btn btn-outline-primary btn-lg m-1" onclick="sympa_uploadRemoveSelected()">Clear</button>        
        </div>
        <div class="btn btn-danger btn-lg m-1" onclick="sympa_uploadModalClose()">×</div>       
      </div>
      <div class="modal-body">
        
        <form action="/image-upload" class="dropzone" id="my-dropzone">
            <div class="dz-message" data-dz-message><span>Drop files here or click to upload</span><br><span style="color:#666; font-size:12px;">.txt, .zip, .pdf, .docx, .xlsx, .md, .csv</span></div>
        </form>       

      </div>      
      
      
	<div class="alert alert-warning alert-dismissible" role="alert" style="display:none; margin-bottom: 0;">
        <span id="sympa-upload-modal-message">...</span> 
        <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'" ></button>
	</div>
    
    </div>
  </div>
</div>









<div class="modal sympa-modal" id="sympa-edit-file-info-modal" style="display:none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit image properties</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="document.getElementById('sympa-edit-file-info-modal').style.display='none'"></button>
      </div>
      <div class="modal-body">
        
      <div class="mb-3">
        <p class="m-0">Name:</p>
        <input type="text" class="form-control" id="sympa-edit-file-info-modal-name-input" aria-describedby="">
      </div>

      <div class="mb-3">
        <p class="m-0">Description:</p>
        <textarea class="form-control" id="sympa-edit-file-info-modal-description-input" rows="3"></textarea>
      </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="sympa_saveEditImageInfoAction()">Save</button>
      </div>

	<div class="alert alert-warning alert-dismissible" role="alert" style="display:none; margin-bottom: 0;">
	   <span id="sympa-create-modal-message">...</span> 
	  <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'" ></button>
	</div>

    </div>
  </div>
</div>








<div class="modal sympa-modal" id="sympa-delete-file-modal" style="display:none;">
  <div class="modal-dialog" style="max-width: 40% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="document.getElementById('sympa-delete-file-modal').style.display='none'"></button>
      </div>
      <div class="modal-body">
        
      <div class="mb-3">
        <p class="m-0"> Delete file '<span id="sympa-delete-file-modal-name"></span>' ? </p>
      </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" onclick="sympa_deleteFileModalAction()">Delete</button>
      </div>

	<div class="alert alert-warning alert-dismissible" role="alert" style="display:none; margin-bottom: 0;">
	   <span id="sympa-create-modal-message">...</span> 
	  <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'" ></button>
	</div>

    </div>
  </div>
</div>











<div class="modal sympa-modal" id="sympa-bulk-ask-delete-modal" style="display:none;">
  <div class="modal-dialog" style="max-width: 40% !important;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete file</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="document.getElementById('sympa-bulk-ask-delete-modal').style.display='none'"></button>
      </div>
      <div class="modal-body">
        
      <div class="mb-3">
        <p class="m-0"> Are you sure you want to delete file(s)? </p>
      </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" onclick="sympa_bulkdeleteModalAction()">Delete</button>
      </div>

	<div class="alert alert-warning alert-dismissible" role="alert" style="display:none; margin-bottom: 0;">
	   <span id="sympa-create-modal-message">...</span> 
	  <button type="button" class="btn-close" onclick="this.parentElement.style.display='none'" ></button>
	</div>

    </div>
  </div>
</div>
















<script src="{{rootUrl}}/assets/vendor/lightbox2-master/dist/js/lightbox-plus-jquery.min.js"></script>
<script src="{{rootUrl}}/assets/vendor/dropzone-v6.0.0-beta.2/dropzone-min.js"></script>

<script>

let myDropzone = new Dropzone("#my-dropzone", { 
        url: "/file-upload",
        paramName: "file",
        autoProcessQueue: false,
        maxFilesize: 2, // Maximum file size in MB
        acceptedFiles: ".txt,.zip,.pdf,.docx,.xlsx,.md,.csv", // Limit accepted file types
        parallelUploads: 10, // Number of files to upload in parallel
        maxFiles: null, // No limit on the total number of files
        init: function() {
            this.on("sending", function(file, xhr, formData){
                formData.append("slug", "{{slug}}");
            });
        }
    });


function sympa_openUploadModalAction(){
    document.getElementById("sympa-upload-modal").style.display = 'block';
    myDropzone.removeAllFiles(true);
}

function sympa_uploadModalAction(){
    myDropzone.processQueue();
}

function sympa_uploadRemoveSelected(){
    myDropzone.removeAllFiles(true);
}

function sympa_saveEditImageInfoAction(){
    console.log("sympa_saveEditImageInfoAction");
}

function sympa_uploadModalClose(){
    document.getElementById('sympa-upload-modal').style.display='none';
    window.location.reload();
}
////

function sympa_copyToClipboard(text) {
    const tempInput = document.createElement("input");
    tempInput.value = text;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);
    sympa_message("Text copied: " + text, "success");
}


function sympa_drawList(data)
{         
    
    let _createItem = function(x){
        
        const name = x.name;
        const group = x.group;
        const description = x.description;
        const slug = x.slug;
        const dir = x.dir;
        const url = x.url;
        const download = x.download;
        
        /*
        description: "test"​​​​
        group: "group-one"​​​​
        name: "Image one"​​​​
        slug: "image-one"​​​​
        url: "http:
        */
        
        return `
         <li class="list-group-item d-flex justify-content-between bg-body-tertiary" title="${description}">
            <div class="d-flex gap-3">                
                <input class="form-check-input sympa-bulk-checkbox" type="checkbox">
                <div class="d-flex justify-content-center align-items-center gap-1">  
                
                    <div class="d-flex justify-content-center align-items-center">  
                        <i style="font-size:32px;" class="bi bi-file-text"></i>
                    </div>
                    
                    <div class="sympa-file-container-text">
                        <div style="display: flex;"> <h6 class="my-0">${name}</h6></div>  
                        <small>${description}</small>
                    </div>
                </div>
            </div>            
            <span class="text-success">
                <div class="btn-group" role="group" aria-label="Basic outlined example"> 
                   <!--              
                  <div onclick="sympa_openEditImageInfoModal('${group}', '${slug}', '${url}')" class="btn btn-primary btn-sm sympa-list-font" target="_blank">Edit</div>
                  -->
                  <a href="${download}" class="btn btn-primary btn-sm sympa-list-font" target="_blank">Download</a>
                  <div onclick="sympa_copyToClipboard('${download}')" class="btn btn-primary btn-sm sympa-list-font" target="_blank">Copy link</div>
                  <div onclick="sympa_deleteImageModal('${dir}', '${name}')" class="btn btn-outline-primary btn-sm sympa-list-font">Delete</div>
                </div>            
            </span>
          </li>
        `;        
    }
    
    let htmlData = `
        <li id="sympa-list-titlebar" class="list-group-item d-flex justify-content-between">             
			<div>
                <div class="sympa-bulk-actions">
                    <div>
                    <input style="margin-right: 1rem;" class="form-check-input" type="checkbox" onclick="sympa_tableCheck(this.checked)">
                    </div>     
                    <select class="form-select sympa-toolbar-font" aria-label="Default select example">
                      <option onclick="sympa_changeBulkMode(this)" value="none" selected>Bulk actions...</option>
                      <option onclick="sympa_changeBulkMode(this)" value="delete-items">Delete items</option>
                    </select>
                    <div onclick="sympa_applyBulk()" class="btn btn-light btn-sm sympa-toolbar-font">Apply</div>
                </div>                
                
            </div>
			<div class="d-flex">
            
                <button data="" style="display:none" onclick="sympa_openSetListValueModal()" id="sympa-list-value-button" type="button" class="btn btn-light btn-sm sympa-toolbar-font">Enter value...</button>
                            
                <div class="sympa-list-options mx-1">                    
                    <select id="sympa-select-right-sort" class="form-select sympa-toolbar-font" aria-label="Default select example">
                      <option selected onclick="sympa_changeListSort(this)" value="newest">Newest</option>
                      <option onclick="sympa_changeListMode(this)" value="oldest">Oldest</option>                
                    </select>
                    <button onclick="sympa_goAction()" type="button" class="btn btn-light btn-sm sympa-toolbar-font">Go</button>
                </div>                               
            </div>
        </li>   
    `;
    
    let listElement = document.getElementById("sympa-file-list");     
    
    for (const key in data.files) {
        htmlData += _createItem(data.files[key]);
    }
    
    htmlData += `
        <li class="list-group-item d-flex justify-content-between" id="sympa-list-bottom-bar">
            <div>Total: <span id="sympa-total-articles"></span> </div>
            <div id="sympa-bottom-right-message">::</div>
        </li> 
    `;
    
    listElement.innerHTML = htmlData;
    
    let totalArticlesElement = document.getElementById("sympa-total-articles");
    totalArticlesElement.innerHTML = data.count + ' item(s)';   
}


async function sympa_getImages(groupSlug){
    const response = await fetch('/file-get-group-files/' + groupSlug); 
	const jsonData = await response.json();
	if (response.status != 200){
		console.log('ERROR!');
		return null;
	}
    
    if (!jsonData.data){
        sympa_message("Missing 'data' object. Bad url or invalid json format!");
        throw new Error("Missing 'data' object. Bad json format!");
        // "sympa-no-file-list"
        // "sympa-main-content"
    }
    
    return jsonData;
}


async function sympa_deleteImage(uuid){
    const response = await fetch('/file-single-delete/' + uuid); 
	const jsonData = await response.json();
	if (response.status != 200){
		console.log('ERROR!');
		return null;
	}

    sympa_message("File deleted!");
    
    return jsonData;
}




async function sympa_openEditImageInfoModal(group, slug, url){
    localStorage.setItem("sympa-file-edit-group", group);
    localStorage.setItem("sympa-file-edit-slug", slug);
    localStorage.setItem("sympa-file-edit-url", url);
    document.getElementById('sympa-edit-file-info-modal').style.display = "block";
    
    const jsonInfo = await sympa_getImageInfo(url);
    if (!(jsonInfo.name && jsonInfo.slug && jsonInfo.description)) {
        sympa_message("Can't load info.json properly.", "danger");
        return;
    }
    
    document.getElementById('sympa-edit-file-info-modal-name-input').value = jsonInfo.name;
    document.getElementById('sympa-edit-file-info-modal-description-input').value = jsonInfo.description;    
}

function sympa_editImageInfo(){
    console.log(3244234234); 
}

async function sympa_getImageInfo(url){
    const response = await fetch(url + '/info.json'); 
	const jsonData = await response.json();
	if (response.status != 200){
		console.log('ERROR!');
		return null;
	}
     
    return jsonData;
}

async function sympa_getGroupInfo(){   
    const url = '{{filesUrl}}' +'/'+ '{{slug}}' +'/info.json';

    const response = await fetch(url); 
	const jsonData = await response.json();
	if (response.status != 200){
		console.log('ERROR!');
		return null;
	}
     
    return jsonData;
}

function sympa_getSelectedItemIds(){
    const elements = document.querySelectorAll('.sympa-bulk-checkbox');
    let selectedIds = [];
    elements.forEach(function(element) {
        if (element.checked){
            const dataId = element.parentElement.parentElement.getAttribute('data-id');
            selectedIds.push(dataId); 
        }
    });
    
    console.log("selectedIds", selectedIds);
    return selectedIds;
}



async function sympa_deleteImageModal(uuid, name){
    document.getElementById('sympa-delete-file-modal').style.display = "block";    
    localStorage.setItem("sympa-file-edit-uuid", uuid);
    localStorage.setItem("sympa-file-edit-name", name);
    document.getElementById('sympa-delete-file-modal-name').innerHTML = name;    
}


async function sympa_deleteFileModalAction(){
    /*
    const group = '{{slug}}';
    const uuid = localStorage.getItem("sympa-file-edit-uuid");
    const name = localStorage.getItem("sympa-file-edit-name");
    console.log(uuid +' '+ name +' '+ group);
    */
    
    const uuid = localStorage.getItem("sympa-file-edit-uuid");
    const jsonData = await sympa_deleteFile(uuid);
}


async function sympa_deleteFile(uuid){
    
    let postData = new FormData();  
    postData.append('uuid', uuid);
    postData.append('group', '{{slug}}');

    const response = await fetch('/file-single-delete', {
        method: 'POST', 
        body: postData,
    });

    const jsonData = await response.json();
    if (response.status != 200) {	        
        sympa_message(jsonData.message);	
        return;
    }
    else{
        sympa_message("File deleted!", "success");
            setTimeout(function () {
            window.location.reload();
        }, 2000);
    } 
  
}


async function sympa_bulkDeleteFiles(uuids){
    
    let postData = new FormData();  
    postData.append('uuids', uuids);
    postData.append('group', '{{slug}}');

    const response = await fetch('/file-bulk-delete', {
        method: 'POST', 
        body: postData,
    });

    const jsonData = await response.json();
    if (response.status != 200) {	        
        sympa_message(jsonData.message);	
        return;
    }
    else{
        sympa_message("File(s) deleted!", "success");
            setTimeout(function () {
            window.location.reload();
        }, 2000);
    } 
  
}

function sympa_tableCheck(checked){
    if (checked){
        const elements = document.querySelectorAll('.sympa-bulk-checkbox');
        elements.forEach(function(element) {
            console.log(element);
            element.checked = true;
        });
    }
    else{
        const elements = document.querySelectorAll('.sympa-bulk-checkbox');
        elements.forEach(function(element) {
            console.log(element);
            element.checked = false;
        });
    }    
}


function sympa_changeBulkMode(that){
    if (that.value === 'none'){
        localStorage.setItem('sympa-image-list-bulk-mode', 'none');
    }
    if (that.value === 'delete-items'){
        localStorage.setItem('sympa-image-list-bulk-mode', 'delete-items');
    }
}




async function sympa_initList(){
    const imagesJsonObj = await sympa_getImages('{{slug}}');
        
    if (imagesJsonObj.data.count === 0){
        document.getElementById('sympa-no-file-list').style.display = "block";
        document.getElementById('sympa-main-content').style.display = "none";
        
    }
    else{        
        sympa_drawList(imagesJsonObj.data);
        // sympa-title
    }  
      
    const groupJsonObj = await sympa_getGroupInfo();
    document.getElementById('sympa-title').innerHTML = groupJsonObj.name;
}




async function sympa_applyBulk(){
    console.log("BULK");
    //sympa_getSelectedItemIds();
    
    const bulkMode = localStorage.getItem('sympa-image-list-bulk-mode');
    
    if (bulkMode === 'delete-items'){        
        document.getElementById("sympa-bulk-ask-delete-modal").style.display = "block";
    }  
    
}



async function sympa_bulkdeleteModalAction(){
    const selectedItems = sympa_getSelectedItemIds(); 
    if (selectedItems){            
        await sympa_bulkDeleteFiles(selectedItems);
        document.getElementById("sympa-bulk-ask-delete-modal").style.display = "none";
        console.log("selectedItems  +++ ");
    } 
}



//MAIN
window.addEventListener("load", async function(){
   
  await sympa_initList();  

});


/*
sympa-no-file-list
sympa-main-content
*/


</script>














